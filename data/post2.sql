CREATE TEMP TABLE prem_games (
    ramp_event_id BIGINT
);
INSERT INTO prem_games (ramp_event_id)
VALUES
(12899906),
(13664458),
(13166256),
(13254873),
(13840349),
(12565919),
(13201980),
(13471045),
(12931176),
(12804251),
(12899939),
(13622601),
(12767498),
(13266283),
(12731561),
(13202031),
(12309924),
(13089594),
(13026610),
(12731620),
(13058814),
(13635243),
(13471043),
(13119696),
(13398487),
(13434775),
(13501229),
(13166255),
(13664448),
(13736285),
(12569993),
(12866485),
(13089584),
(12804236),
(13026607),
(13177400),
(13635242),
(13202060),
(12731559),
(12627908),
(13501222),
(12609338),
(13471046),
(13664437),
(13119695),
(13332161),
(13432606),
(12627894),
(13303996),
(13202045),
(13635241),
(13026608),
(13701684),
(12866488),
(13534383),
(13254882),
(12866486),
(12899936),
(12309932),
(13736264),
(13076336),
(13701723),
(12609330),
(12931181),
(13770873),
(12731638),
(13471044),
(13398471),
(13058812),
(13664453),
(12697139),
(13119652),
(13840261),
(13701728),
(13770865),
(12931213),
(12570022),
(13089603),
(12767492),
(12609295),
(12866473),
(12866480),
(13534441),
(13840360),
(13058792),
(13166267),
(12731551),
(13398473),
(13166260),
(13076335),
(13089560),
(13177422),
(13299444),
(13635253),
(12767523),
(12767507),
(12565942),
(13058823),
(13534442),
(13534450),
(13621899),
(12963209),
(13840362),
(13202028),
(12565858),
(13119698),
(13701667),
(12866484),
(13149204),
(13177380),
(12309967),
(12899942),
(12309964),
(12609284),
(12573378),
(13432485),
(12627901),
(12804254),
(13736276),
(13026598),
(13266318),
(13303993),
(13089613),
(13149183),
(12697142),
(12731642),
(13432192),
(13501245),
(13635235),
(13266324),
(12931197),
(13076327),
(13177390),
(12309863),
(13501234),
(13534452),
(12565534),
(12570007),
(13534448),
(13736295),
(13026597),
(13254876),
(12963262),
(13299468),
(12931191),
(13058802),
(13076315),
(13177396),
(12565951),
(13254856),
(13621898),
(12565926),
(13303997),
(12627898),
(12899890),
(12565944),
(13701744),
(12570006),
(12609321),
(13177402),
(13201967),
(13635250),
(13166264),
(13501246),
(13432980),
(12570004),
(13398478),
(12570017),
(13770859),
(12804230),
(12963260),
(13089585),
(13058799),
(13299426),
(13398465),
(13299439),
(13149169),
(13254874),
(13398475),
(13501225),
(13501232),
(12565539),
(13119662),
(13436135),
(12963213),
(13534459),
(13201958),
(13303989),
(13331911),
(13471042),
(12627904),
(12866490),
(12767530),
(12609302),
(13149202),
(13166244),
(13534455),
(13770878),
(13089576),
(13149200),
(13166257),
(13770845),
(13432626),
(13635249),
(13736294),
(13254831),
(13398464),
(13471050),
(12731599),
(13076334),
(13331873),
(13840364),
(13089593),
(12731568),
(13471036),
(13840249),
(12627906),
(12931212),
(13177392),
(12569990),
(13299424),
(12697144),
(13058797),
(12697145),
(13119660),
(12609300),
(12899937),
(13664450),
(13089583),
(13119680),
(12931200),
(13671989),
(12565936),
(12899874),
(13149176),
(12627905),
(12697137),
(13333916),
(13635251),
(13701732),
(13701672),
(13635244),
(13736273),
(12804253),
(13201999),
(13149179),
(13266287),
(13621897),
(13026593),
(13635231),
(13433253),
(13664460),
(13770857),
(12309927),
(13770861),
(13166263),
(13635252),
(12697143),
(12697140),
(13398474),
(12309937),
(12866487),
(13299445),
(13331843),
(12804239),
(13254845),
(13840363),
(13119686),
(13621886),
(12627897),
(13058815),
(13149180),
(12931201),
(12963191),
(13026600),
(13436812),
(13664440),
(12627903),
(12731640),
(13471047),
(13770868),
(12569994),
(12866470),
(13621882),
(13119674),
(13621881),
(13434776),
(13501221),
(12804231),
(13089598),
(13202013),
(13177397),
(12731553),
(13177394),
(13501231),
(13770876),
(12697151),
(13149186),
(12899910),
(13840443),
(12609319),
(13026628),
(13334690),
(12627902),
(13501227),
(13664449),
(12804247),
(13331842),
(13372047),
(13299455),
(12866493),
(12899907),
(13398470),
(13534451),
(13736281),
(12931215),
(12899934),
(13202012),
(13254844),
(13331846),
(12565918),
(12609285),
(12309918),
(12963193),
(13149240),
(13621907),
(13058811),
(13254846),
(13076328),
(13089581),
(13076323),
(13076308),
(13270881),
(13701731),
(13840354),
(12804248),
(13266306),
(13621893),
(12767494),
(12963298),
(13026617),
(13177411),
(13534446),
(13664462),
(12309965),
(13058817),
(13119688),
(12309966),
(13331884),
(13736284),
(12767539),
(12963201),
(12963248),
(12767561),
(13026616),
(12609339),
(12767536),
(13770854),
(13266273),
(13840361),
(12767537),
(12931196),
(12963227),
(12570016),
(13254843),
(13398460),
(12697152),
(13270883),
(13701719),
(13076317),
(13266266),
(13336698),
(13736260),
(12697150),
(13266460),
(13166265),
(13166259),
(13736300),
(13621876),
(13701678),
(12804252);

-- Build selection db, selections with quanitiies teams, players, result
CREATE TEMP TABLE sot_selections
DISTSTYLE KEY 
DISTKEY (selection_id) AS
SELECT
    rs.selection_id,
    rs.market_id,
    rs.event_id,
    s.event_name,
    TRIM(SPLIT_PART(s.event_name, ' v ', 1)) AS home_team,
    TRIM(SPLIT_PART(s.event_name, ' v ', 2)) AS away_team,
    s.market_name,
    rs.selection_name,
    CASE    
        WHEN rs.result_type = 'WIN' THEN 1
        ELSE 0
    END AS result_type,
    -- Extract minimum quantity threshold
    CASE

        WHEN REGEXP_SUBSTR(TRIM(market_name), '\\d+') IS NOT NULL THEN
            CAST(NULLIF(TRIM(REGEXP_SUBSTR(TRIM(market_name), '\\d+')), '') AS INTEGER)
        WHEN REGEXP_SUBSTR(TRIM(selection_name), '\\d+') IS NOT NULL THEN
            CAST(NULLIF(TRIM(REGEXP_SUBSTR(TRIM(selection_name), '\\d+')), '') AS INTEGER)
        ELSE NULL
    END AS sot_level,
    COUNT(DISTINCT leg_id) AS bets_laid
FROM 
    omni_betevent.ramp_vw_selection rs
JOIN 
    prem_games pg
ON  
    pg.ramp_event_id = rs.event_id
JOIN
    omni_sportsbook.vw_sportsbook_summary s
ON
    rs.selection_id = s.ramp_selection_id
    AND rs.market_id = s.ramp_market_id
    AND rs.event_id = s.ramp_event_id
WHERE
    1=1
    AND s.market_name LIKE '%Target%'
    AND s.market_name != 'Player Headed Shots On Target'
    AND s.market_group = 'Player Props'
    AND s.market_name NOT LIKE '%Outside%'
    AND brand = 'PP'
    AND s.placed_datetime > '2024-08-01'::DATE
    AND s.placed_datetime < '2025-06-01'::DATE
GROUP BY 
    1,2,3,4,5,6,7,8,9,10;

-- Create player level table with min result, so if min quantity is 1 and lose, then 0 else min quant when win, for each player in each game thats backed
CREATE TEMP TABLE sot_actual AS
SELECT
    ss.event_id,
    ss.home_team,
    ss.away_team,
    ss.selection_name,
    -- calc actual_sot as an aggregate for each group
    CASE
        WHEN MAX(CASE WHEN ss.sot_level = 1 AND ss.result_type = 0 THEN 1 ELSE 0 END) = 1 THEN 0
        WHEN MIN(CASE WHEN ss.result_type = 1 THEN ss.sot_level ELSE NULL END) IS NOT NULL THEN
            MIN(CASE WHEN ss.result_type = 1 THEN ss.sot_level ELSE NULL END)

        ELSE NULL
    END AS actual_sot
FROM
    sot_selections ss
WHERE
    LENGTH(ss.selection_name) - LENGTH(REPLACE(ss.selection_name, '|', '')) < 2
GROUP BY
    ss.event_id,
    ss.home_team,
    ss.away_team,
    ss.selection_name;

-- Get number of woodwork hit per game. Using 2023/2024 data for this
-- 198 posts/ 3,765 SOT = 0.05 

-- Get next sot level
CREATE TEMP TABLE sot_with_next_laid AS
SELECT DISTINCT
    ss2.event_id,
    ss2.market_id,
    ss2.selection_id,
    ss2.home_team,
    ss2.away_team,
    ss2.event_name,
    ss1.selection_name,
    sa.actual_sot,
    ss2.sot_level,
    ss1.bets_laid,
    ss2.bets_laid AS total_bets_laid_on_next_sot_level,
    ss2.result_type,
    ss2.sot_level AS next_sot_level_laid
FROM
    sot_actual sa
JOIN
    sot_selections ss1
ON
    sa.event_id = ss1.event_id
    AND sa.home_team = ss1.home_team
    AND sa.away_team = ss1.away_team
    AND sa.selection_name = ss1.selection_name
JOIN
    sot_selections ss2
    ON ss1.event_name = ss2.event_name
    AND ss1.home_team = ss2.home_team
    AND ss1.away_team = ss2.away_team
    AND ss1.selection_name = ss2.selection_name 
    AND sa.actual_sot + 1 = ss2.sot_level
WHERE 
    ss1.sot_level IS NOT NULL;

-- DROP TABLE IF EXISTS trading_shared.sot_bets_24_25;
-- CREATE TABLE trading_shared.sot_bets_24_25 AS
SELECT DISTINCT
    sl.event_id,
    sl.market_id,
    sl.selection_id,
    sl.home_team,
    sl.away_team,
    sl.selection_name,
    sl.sot_level,
    sl.actual_sot,
    sl.total_bets_laid_on_next_sot_level,
    sl.next_sot_level_laid
FROM
    sot_with_next_laid sl
ORDER BY
    event_id, home_team, away_team, selection_name, sot_level;
